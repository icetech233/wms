@namespace WmsApp.Pages.StockIn
@page "/stockin/requestform"
@using System.Text.Json.Serialization
@using WmsApp.Models
@using System.Text.Json

@inject NotificationService _notice

<GridContent Id="#main">
    @* 申请入库 *@
    <WmsApp.FormTitle CurrentFormTitle=@requestFormTitle />

    @* 申请入库表单 *@
    <Form TModel=@StockAddModel Model=@stockModel>
        
        <Row Align="top" Gutter=24>
            <Col Xs=24 Sm=12 Md=8 Lg=6 Xl=5>
                <FormItem Label="入库单号">
                    <Input @bind-Value="@context.StockInNo" />
                </FormItem>
            </Col>
            <Col Xs=24 Sm=12 Md=8 Lg=6 Xl=4>
                <FormItem Label="类型">
                        <Select TItem=@Dict TItemValue=@string DataSource=@_stockInTypes
                            DefaultActiveFirstOption=true EnableSearch=true
                        LabelName="DictValue" ValueName="DictValue"
                        @bind-Value="@context.StockInType">
                        </Select>
                </FormItem>
            </Col>
            <Col Xs=24 Sm=12 Md=8 Lg=6 Xl=5>
                <FormItem Label="仓库">
                    <Select TItem=@Warehouse TItemValue=@string DataSource=@_warehouses
                            DefaultActiveFirstOption=true EnableSearch=true
                            LabelName="WarehouseName" ValueName="WarehouseName"
                            @bind-Value="@context.StockInWarehouse"
                            Placeholder="选择一个仓库" />
                </FormItem>
            </Col>
            <Col Xs=24 Sm=12 Md=8 Lg=6 Xl=5>
                <FormItem Label="供应商">
                    <Select TItem=@Tenant TItemValue=@string DataSource=@_stockInSupplier
                            DefaultActiveFirstOption=true EnableSearch=true
                            LabelName="TenantName" ValueName="TenantName"
                            @bind-Value="@context.Supplier">
                    </Select>
                </FormItem>
            </Col>
            <Col Xs=24 Sm=12 Md=8 Lg=6 Xl=5>
                <FormItem Label="合同号">
                    <Input @bind-Value="@context.ContractNo" />
                </FormItem>
            </Col>
        </Row>
    </Form>
    <WmsApp.FormTitle CurrentFormTitle="网关入库明细" />

    @* *@
    <Space Style="margin-bottom:12px">
        <SpaceItem>
            <Button Size=@buttonSize Icon=@("import") Type="primary">导入</Button>
        </SpaceItem>
        <SpaceItem>
            <Button Size=@buttonSize Icon=@("cloud-download")
                    Type="default" OnClick="DownloadTemplate">下载模板
            </Button>
        </SpaceItem>
    </Space>
    @* table *@
    <Table DataSource="skuStockList" TItem="StockItem" RowClassName="@(_=>"editable-row")"
           Bordered @bind-PageIndex=@_pageIndex @bind-PageSize=@_pageSize @ref=_table
           FooterTemplate=@footerTemplate(AddItem)>

        <PropertyColumn Title="Id" Property="c=>c.Id" Width="50" Fixed="left">
             <span>@context.Id</span>
        </PropertyColumn>
        <Column TData="string" Title="型号">
            @if (!editCache[context.Id].edit)
            {
                @context.SkuType
            }
            else
            {
                @* <Input @bind-Value="editCache[context.Id].data.SkuType"/>*@
                <Select TItem=@SimplySku TItemValue=@string DataSource=@_skuList
                        DefaultActiveFirstOption=true EnableSearch=true
                        LabelName="SkuCode" ValueName="SkuCode"
                        @bind-Value="editCache[context.Id].data.SkuType">
                </Select>
            }
        </Column>
        <Column TData="string" Title="Mac地址">
            @if (!editCache[context.Id].edit)
            {
                @context.Mac
            }
            else
            {
                <Input @bind-Value="editCache[context.Id].data.Mac" />
            }
        </Column>
        <Column TData="string" Title="Iccid号">
            @if (!editCache[context.Id].edit)
            {
                @context.Iccid
            }
            else
            {
                <Input @bind-Value="editCache[context.Id].data.Iccid" />
            }
        </Column>
        <ActionColumn Title="操作">
            @if (!editCache[context.Id].edit)
            {
                <Button Size=@("default") OnClick="() => StartEdit(context.Id)" Style=@("margin-right: 8px;")
                        Icon="@IconType.Outline.Edit"></Button>

                <Button Size=@("default") OnClick="() => DeleteItem(context.Id)"
                        Icon="@IconType.Fill.Delete"
                    Danger Type="@ButtonType.Primary"></Button>
            }
            else
            {
                <Button Size=@("default") OnClick="() => SaveEdit(context.Id)" Style=@Constants.mr2
                        Icon="@IconType.Outline.Save">
                    保存
                </Button>

                <Button Size=@("default") OnClick="() => CancelEdit(context.Id)" Style=@Constants.mr2
                        Icon="@IconType.Outline.CloseCircle">
                    取消
                </Button>
            }
        </ActionColumn>

    </Table>

    <div>
        <div>
            <span>本次入库总量: @(skuStockList.Count)</span>
        </div>

        @if (skuStockList.Count > 0) {
            <Space Wrap>
            @foreach (var tmp in skuStockList.GroupBy(x => x.SkuType))
            {
                <SpaceItem>
                    <span>@(tmp.Key)</span><span>数量:</span><span>@(tmp.Count())</span>
                </SpaceItem>
            }
            </Space>
        }
    </div>

    <WmsApp.FormTitle CurrentFormTitle="入库确认" />
    <Form TModel=@StockAddModel Model=@stockModel
          OnFinish=OnFinish OnFinishFailed=OnFinishFailed>

        <Row Align="top" Gutter=24>
            <Col Xs=24 Sm=12 Md=6 Lg=6 Xl=6>
                <FormItem Label="入库时间">
                    <DatePicker Format="yyyy-MM-dd hh:mm:ss" ShowTime=true @bind-Value=@context.InTime />
                </FormItem>
            </Col>
            <Col Xs=24 Sm=12 Md=6 Lg=6 Xl=6>
                <FormItem Label="入库人员">
                    <Select TItem=@string TItemValue=@string DataSource=@_personList
                                DefaultActiveFirstOption=true EnableSearch=true
                                @bind-Value="@context.Staff">
                    </Select>
                </FormItem>
            </Col>
            <Col Xs=24 Sm=12 Md=6 Lg=6 Xl=6>
                <FormItem Label="审核人员">
                     <Select TItem=@string TItemValue=@string DataSource=@_personList
                            DefaultActiveFirstOption=true EnableSearch=true
                        @bind-Value="@context.Reviewer" />
                </FormItem>
            </Col>
        </Row>
        <Row>
            <Button Type=@ButtonType.Primary HtmlType="submit">提交</Button>
        </Row>
    </Form>
</GridContent>

<style>
    .btn-add {
        display: block;
        margin: 0px 0px;
        width: 100%;
    }

    .ant-table-footer {
        padding: 4px 4px !important;
    }
</style>

@code {
    private void OnFinish(EditContext editContext)
    {
        Console.WriteLine($"OnFinish {JsonSerializer.Serialize(stockModel)}");
    }
    private void OnFinishFailed(EditContext editContext)
    {
        Console.WriteLine("Failed");
    }
    RenderFragment footerTemplate(Action clickA) => @<Button Class="btn-add" Icon=@IconType.Fill.PlusSquare OnClick=clickA>添加一行数据</Button>;

    public class StockAddModel
    {
        /// <summary>
        /// 入库单号
        /// </summary>
        [Required]
        public string StockInNo { get; set; }

        [Required, Description("入库类型")]
        public string StockInType { get; set; }
        [Required, Description("入库仓库")]
        public string StockInWarehouse { get; set; }
        [Required, Description("供应商")]
        public string Supplier { get; set; }
        [Required, Description("合同号")]
        public string ContractNo { get; set; }
        [JsonIgnore]
        [Description("入库时间")]
        public DateTime InTime { get; set; } = DateTime.Now;
        public string StockInTime
        {
            get { return InTime.ToString("yyyy-MM-dd hh:mm:ss"); }
        }

        [Required, Description("入库人员")]
        public string Staff { get; set; }
        [Required, Description("审核人员")]
        public string Reviewer { get; set; }

        // [Required]
        // public bool IsSure { get; set; } = false;
    }

}
